<html>
  <head>
    <script src="/build/magicFabric.web.js"></script>
    <script src="/node_modules/dom-to-image/dist/dom-to-image.min.js"></script>
  </head>
  <body>
    <style>
    .links {
      /* stroke: rgba(51, 51, 51, 0.1); */
      /* stroke: rgb(16, 142, 233); */
    }
    .domain {
      display: none;
    }
    </style>
    <div style="zoom:0.5">
      <canvas style="position:fixed;top;0px;left:0px" width="900" height="900"></canvas>
      <svg style="position:fixed;top;0px;left:0px" width="900" height="900" id="d3Container"></svg>
    </div>

    <script src="/build/d3.v4.min.js"></script>
    <script src="/build/d3-contour.v1.min.js"></script>
    <script src="/build/d3-scale-chromatic.v1.min.js"></script>

    <script>
    let simulation, graph;

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function scale(data) {
      return data / 1;
    }

    let div = document.createElement("div");
    let xhr=new XMLHttpRequest();
    let svgUrl = "/resources/Z.svg";
    xhr.onload = (...args) => {
      div.innerHTML = xhr.responseText;
      graph = magicFabric(div.firstChild);

      var svg = d3.select("svg"),
          width = +svg.attr("width"),
          height = +svg.attr("height");

      var canvas = d3.select("canvas");
      var context = canvas.node().getContext('2d');

      context.fillStyle = '#333333';
      context.strokeStyle = '#000000';
      var path = d3.geoPath().context(context);

      simulation = d3.forceSimulation(graph.nodes)
          .force("link", d3.forceLink(graph.edges).id(function(d) { return d.id; })
          .strength(2)
          .distance((d) => {
            return d.distance;
          }))
          .on("tick", ticked);

      var link = svg.append("g")
          .attr("class", "links")
        .selectAll("line")
        .data(graph.edges)
        .enter().append("line")
          .attr("stroke-width", function(d) { return 0.1 });

      var node = svg.append("g")
          .attr("class", "nodes")
        .selectAll("circle")
        .data(graph.nodes)
        .enter().append("circle")
          .attr("r", 30)
          .attr("stroke", "rgba(193, 193, 193, 0)")
          .attr("fill", function(d) { return "rgba(0,0,0, 0)" })
          .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended));

      node.append("title")
          .text(function(d) { return d.id; });

      document.addEventListener("mousemove", (e) => {
        let x = e.offsetX, y = e.offsetY;

        let dist = (x2, y2) => {
          return Math.sqrt((x2-x)**2 + (y2-y)**2);
        };

        let distance = Math
        // simulation.force("radial", d3.forceRadial(2).strength((d) => {
        //   return -1/(dist(d.x, d.y));
        // }));

        // simulation.force("x", d3.forceX(x).strength((d)=>{
        //   // console.log({strength: -0.1/(Math.abs(e.offsetX-d.x))});
        //
        // }));
        // simulation.force("y", d3.forceY(y).strength((d)=>{
        //   // console.log({strength: -0.1/(Math.abs(e.offsetX-d.x))});
        //   return -10/(dist(d.x, d.y));
        // }));
        // simulation.force("y", d3.forceY(y).strength(-0.008));

      });

      function ticked(...args) {


       // console.log({x});

       // d3.select(this).force("center", [0,0]);

       let data = d3.contourDensity()
             .x(function(d) { return scale(d.x); })
             .y(function(d) { return scale(d.y); })
             .size([width, height])
             .bandwidth(11)
             .thresholds([0.018])
           (graph.nodes)

	     context.fillStyle = 'none';
     	 context.strokeStyle = 'black';
       context.clearRect(0, 0, width, height);

       context.beginPath();
       path(data[0]);
       context.fill();
       context.stroke();

        link
            .attr("x1", function(d) { return scale(d.source.x); })
            .attr("y1", function(d) { return scale(d.source.y); })
            .attr("x2", function(d) { return scale(d.target.x); })
            .attr("y2", function(d) { return scale(d.target.y); });

        node
            .attr("cx", function(d) { return scale(d.x); })
            .attr("cy", function(d) { return scale(d.y); });
      }
    };

    xhr.open("GET",svgUrl,true);
    xhr.send();

    </script>


  </body>
</html>
